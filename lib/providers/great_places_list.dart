import 'package:flutter/cupertino.dart';

import 'dart:collection';
import 'dart:io';

import '../model/place.dart';
import '../utility/db_helper.dart';

class GreatPlacesList with ChangeNotifier {
  List<Place> _placesList = [];

//addPlace
  void addNewPlace({
    required String pickedTitle,
    required File pickedImage,
    required PlaceLocation pickedLocation,
  }) async {
    final _newRecord = {
      'title': pickedTitle,
      'imagePath': pickedImage.path,
      'latitude': pickedLocation.latitude,
      'longtitude': pickedLocation.longitude,
      'address': pickedLocation.address
    };

    //try to save the place to the SQlLite Database
    final _idGenerated = await DBHelper.insert(
      placeList: _newRecord,
    );

    print('ID generated by DB $_idGenerated');

    final _newPlace = Place(
        id: _idGenerated,
        title: pickedTitle,
        image: pickedImage,
        location: pickedLocation);

    _placesList.add(_newPlace);
    notifyListeners();
  }

  Future<void> fetchAndSetPlaces() async {
    //try to save the place to the SQlLite Database
    final _fetchedList = await DBHelper.select();

    //transform the list to list of places
    print(_fetchedList);
    final List<Place> _transformedList = _fetchedList.map(
      (item) {
        return Place(
          id: item['id'],
          title: item['title'],
          location: PlaceLocation(
              latitude: item['latitude'],
              longtitude: item['longtitude'],
              address: item['address']),
          image: File(
            item['imagePath'],
          ),
        );
      },
    ).toList();

    _placesList = _transformedList;
    notifyListeners();
  }

  Place findPlaceByID(int id) {
    return _placesList.firstWhere((element) => element.id == id);
  }

//removePlace
  deletePlace({
    required int index,
  }) async {
    //get the id
    await DBHelper.delete(id: _placesList[index].id);
    _placesList.removeAt(index);
    notifyListeners();
  }

//should be atomic
  UnmodifiableListView<Place> get placesList =>
      UnmodifiableListView(_placesList);
}
